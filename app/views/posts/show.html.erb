<% content_for :title, "#{@post.title} - Ruby, Python & More" %>
<% content_for :meta_description, truncate(strip_tags(@post.content.to_s), length: 155, separator: ' ') %>
<% content_for :canonical_url, post_url(@post.slug, trailing_slash: false) %>

<article class="post-detail">
  <div class="post-header">
    <%= link_to "â† Back to all posts", root_path, class: "back-link" %>

    <div class="post-meta">
      <span class="category"><%= @post.category_name %></span>
      <span class="date"><%= @post.created_at.strftime("%B %d, %Y") %></span>
      <span class="author">by Scott Goyette</span>
    </div>

    <h1><%= @post.title %></h1>
  </div>

  <div class="post-content">
    <%= @post.content %>
  </div>
</article>

<section class="comments-section">
  <h2>Comments (<%= @comments.count %>)</h2>

  <% if Current.user %>
    <div class="comment-form">
      <h3>Leave a comment</h3>
      <%= form_with model: [@post, @comment], url: post_comments_path(@post.slug) do |f| %>
        <% if @comment.errors.any? %>
          <div class="errors">
            <% @comment.errors.full_messages.each do |message| %>
              <p><%= message %></p>
            <% end %>
          </div>
        <% end %>

        <div class="form-group">
          <%= f.text_area :content, rows: 4, placeholder: "Share your thoughts...", class: "form-control" %>
        </div>
        <%= f.submit "Post Comment", class: "btn btn-primary" %>
      <% end %>
    </div>
  <% else %>
    <p class="login-prompt">
      <%= link_to "Sign in", new_session_path(return_to: request.url) %> to leave a comment.
    </p>
  <% end %>

  <div class="comments-list">
    <% if @comments.any? %>
      <% @comments.each do |comment| %>
        <div class="comment">
          <div class="comment-header">
            <strong><%= comment.user.email_address %></strong>
            <span class="comment-date"><%= time_ago_in_words(comment.created_at) %> ago</span>
          </div>
          <div class="comment-content">
            <%= simple_format(comment.content) %>
          </div>
          <% if Current.user == comment.user || Current.user&.admin? %>
            <div class="comment-actions">
              <%= button_to "Delete", post_comment_path(@post.slug, comment),
                  method: :delete, data: { confirm: "Are you sure?" }, class: "btn-link danger" %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="empty-state">No comments yet. Be the first to comment!</p>
    <% end %>
  </div>
</section>
